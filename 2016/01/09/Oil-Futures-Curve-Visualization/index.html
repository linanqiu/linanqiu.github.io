<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Oil Futures Curve Visualization | Pandamonium | Musings of a Panda</title>
  <meta name="author" content="Linan Qiu">
  
  <meta name="description" content="Linan&#39;s Blog">
  
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Oil Futures Curve Visualization"/>
  <meta property="og:site_name" content="Pandamonium"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Pandamonium" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div id="page" class="site">
  <div id="primary" class="content-area">

    <header id="header" class="inner"><div class="site-branding">
  <h1 class="site-title">
    <a href="/">Pandamonium</a>
  </h1>
  <p class="site-description">Musings of a Panda</p>
</div>
<nav id="site-navigation" class="main-navigation" role="navigation">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
</nav></header>

    <article id="content" class="site-content">
      <main id="main" class="site-main posts-loop" role="main">
        <article class="post article">

  
  
    <h3 class="article-title"><span>Oil Futures Curve Visualization</span></h3>
  


  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/01/09/Oil-Futures-Curve-Visualization/" rel="bookmark">
        <time class="entry-date published" datetime="2016-01-09T17:05:04.000Z">
          2016-01-09
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>This oil thing is getting pretty crazy, especially with Saudi and Iran going bonkers over each other. Futures curves are a great way to speculate, and it’d be great to visualize the movement of the futures curve over different trading days.</p>
<p>I thought this would be a pretty commonsensical thing for yahoo / google finance to provide, but turns out they provide nothing more than a single futures chain (settle prices for futures contracts right now). Historical prices aren’t available, and even if they are, they aren’t in the form of a futures curve. Instead, they are just prices for the specific contract (eg. the futures contract expiring on Feb 2016, not the front month contract and the contract expiring in one month etc). I want the relative numbers, not the absolute ones, hence this.</p>
<p>I want a plot of the current futures prices for the next 12 months. Here’s how to do that simply</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">%matplotlib inline</span><br><span class="line"><span class="comment"># %config InlineBackend.figure_format = 'retina'</span></span><br><span class="line">%config InlineBackend.figure_format = <span class="string">'svg'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas_datareader.data <span class="keyword">as</span> data</span><br><span class="line"><span class="keyword">import</span> pandas_datareader.wb <span class="keyword">as</span> wb</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> pyplot</span><br><span class="line">matplotlib.style.use(<span class="string">'ggplot'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Quandl</span><br><span class="line"></span><br><span class="line">API_KEY = <span class="string">'SUBSTITUTE_YOUR_OWN_API_KEY'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pyplot.rcParams['figure.figsize'] = (10, 10)</span></span><br></pre></td></tr></table></figure>
<p>In Quandl (and in real life), futures contract are named as <code>AAMYYYY</code> where <code>AA</code> is the type of underlying asset (for WTI crude oil, it is <code>CL</code>), <code>M</code> is the month (the whole series of months starting from <code>F</code> to <code>Z</code> is in the array below) and <code>YYYY</code> is the year (eg. <code>2016</code>). Hence, a futures contract for crude oil expiring in March 2016 will be <code>CLH2016</code> or <code>CLH16</code> depending on the source of your data.</p>
<p>We make use of this fact and pull our data (in the form of <code>pandas</code> dataframes) into a dictionary.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">MONTHS = [<span class="string">'F'</span>, <span class="string">'G'</span>, <span class="string">'H'</span>, <span class="string">'J'</span>, <span class="string">'K'</span>, <span class="string">'M'</span>, <span class="string">'N'</span>, <span class="string">'Q'</span>, <span class="string">'U'</span>, <span class="string">'V'</span>, <span class="string">'X'</span>, <span class="string">'Z'</span>]</span><br><span class="line">YEARS = [<span class="number">2014</span>, <span class="number">2015</span>, <span class="number">2016</span>, <span class="number">2017</span>, <span class="number">2018</span>]</span><br><span class="line">PREFIX = <span class="string">'CME/CL'</span></span><br><span class="line"></span><br><span class="line">dataframes = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> month <span class="keyword">in</span> MONTHS:</span><br><span class="line">    <span class="keyword">for</span> year <span class="keyword">in</span> YEARS:</span><br><span class="line">        symbol = <span class="string">'%s%s%d'</span> % (PREFIX, month, year)</span><br><span class="line">        internal_symbol = <span class="string">'%d%s'</span> % (year, month)</span><br><span class="line">        dataframes[internal_symbol] = Quandl.get(symbol, authtoken=API_KEY)</span><br><span class="line">        dataframes[internal_symbol] = dataframes[internal_symbol][<span class="string">'Settle'</span>]</span><br></pre></td></tr></table></figure>
<p>Next, we make some functions that extract the futures price at a given date from each of the dataframes (each of the contracts), skipping them if the date doesn’t exist. For example, there won’t be a settlement price on 5th Jan 2015 for a contract expiring in December 2014.</p>
<p>Then <code>extract_year</code> takes the first 12 prices from the list of prices. The keys for the dataframes are in the form of <code>YYYYMAA</code> so that the year comes first, simplifying the sorting process. Yes I know this is non conventional.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_curve</span><span class="params">(dataframes, date)</span>:</span></span><br><span class="line">    curve = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> symbol, dataframe <span class="keyword">in</span> dataframes.iteritems():</span><br><span class="line">        <span class="keyword">if</span> date <span class="keyword">in</span> dataframe:</span><br><span class="line">            curve[symbol] = dataframe[date]</span><br><span class="line">    <span class="keyword">return</span> curve</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract_year</span><span class="params">(curve)</span>:</span></span><br><span class="line">    pvs = [curve[symbol] <span class="keyword">for</span> symbol <span class="keyword">in</span> sorted(curve)]</span><br><span class="line">    <span class="keyword">return</span> pvs[:<span class="number">12</span>]</span><br></pre></td></tr></table></figure>
<p>Now we can plot our first graph. This plots the futures curve at a certain date.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_year_curve</span><span class="params">(date)</span>:</span></span><br><span class="line">    pyplot.plot(extract_year(get_curve(dataframes, date)))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plot_year_curve(datetime.datetime(<span class="number">2016</span>, <span class="number">1</span>, <span class="number">8</span>))</span><br><span class="line">pyplot.show()</span><br></pre></td></tr></table></figure>
<div class="figure">
<img src="/images/Oil-Futures-Curve-Visualization/output_8_0.svg" alt="svg">
<p class="caption">svg</p>
</div>
<p>That’s useful, but what I really want to know is how the futures curve has shifted over the last few days. I can do this by plotting a whole bunch of these lines, and varying the gradient such that the ones far back in time are red, and the recent ones are green.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_year_curve_range</span><span class="params">(date, shift_back_days)</span>:</span></span><br><span class="line">    date_list = [date - datetime.timedelta(days=x) <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, shift_back_days)]</span><br><span class="line">    <span class="keyword">for</span> index, date <span class="keyword">in</span> enumerate(date_list):</span><br><span class="line">        color = (index / len(date_list))</span><br><span class="line">        pyplot.plot(extract_year(get_curve(dataframes, date)), color=(color, <span class="number">1</span>-color, <span class="number">0</span>), linewidth=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plot_year_curve_range(datetime.datetime(<span class="number">2016</span>, <span class="number">1</span>, <span class="number">8</span>), <span class="number">30</span>)</span><br><span class="line">pyplot.show()</span><br></pre></td></tr></table></figure>
<div class="figure">
<img src="/images/Oil-Futures-Curve-Visualization/output_11_0.svg" alt="svg">
<p class="caption">svg</p>
</div>
<p>The plot above is the futures curve for the last 30 days (non-trading days are included, so there are less than 30 lines in the graph). What we see that initially, the curve flattened, then dropped in a parallel manner, and finally steepening again. In fact, we can visualize the recent steepening a little closer by looking at the last 10 days.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plot_year_curve_range(datetime.datetime(<span class="number">2016</span>, <span class="number">1</span>, <span class="number">8</span>), <span class="number">10</span>)</span><br><span class="line">pyplot.show()</span><br></pre></td></tr></table></figure>
<div class="figure">
<img src="/images/Oil-Futures-Curve-Visualization/output_13_0.svg" alt="svg">
<p class="caption">svg</p>
</div>
<p>This shows that over the last 10 days, the curve has fallen somewhat more on the short end than on the long end (37 to 33 vs 44 to 41).</p>
<p>We can also abuse this for cool artistic effects.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plot_year_curve_range(datetime.datetime(<span class="number">2016</span>, <span class="number">1</span>, <span class="number">8</span>), <span class="number">360</span>)</span><br><span class="line">pyplot.show()</span><br></pre></td></tr></table></figure>
<div class="figure">
<img src="/images/Oil-Futures-Curve-Visualization/output_15_0.svg" alt="svg">
<p class="caption">svg</p>
</div>

      
    </div>
    <footer class="article-footer">
        <div class="article-meta pull-left">
          
          
        </div>
        
    </footer>
  </div>
</article>

  



      </main>
    </article>

    <footer id="colophon" class="site-footer" role="contentinfo"><p class="site-info">
  Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
  Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
  </br>
  
  &copy; 2018 Linan Qiu
  
</p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-66827435-1', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</body>
</html>
